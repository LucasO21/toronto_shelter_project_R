---
title: "Creating Predictions"
date: "`r lubridate::now(tzone = 'EST')` EST"
format: html
theme: flatly
toc: true
toc-depth: 3
number-sections: true
number-depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

# Libraries
library(tidyverse)
library(bigrquery)
library(slider)
library(janitor)
library(tidymodels)
library(h2o)

# Source
source(file = "../functions/extract_shelter_data.R")
source(file = "../functions/extract_weather_forecast.R")
source(file = "../functions/modeling.R")
source(file = "../functions/predictions.R")
```


# Introduction

In this notebook, predictions are created using the h2o automl model created.

---

# Get Data Biq Query

Get the features needed for making predictions from big query

```{r load_data, message=TRUE}

# Get Data From Big Query
pred_features_data_list <- get_pred_features_from_bq()

```

---

# Combine Data

Combine shelter data with weather forecast for predictions. 


```{r combine_data}

# Combine Features for Prediction with Weather Forecast 
pred_features_combined <- get_pred_features_combined(
    pred_features_data_list[[1]], 
    pred_features_data_list[[2]]
)

pred_features_combined %>% glimpse()
```


---

# Make Predictions

## Step 1: Data Preprocessing (Recipes) 

Pre-process data and transform to h2o objects.

```{r data_preprocessing}

# Recipes
pred_data_processed_list <- get_prediction_recipes(pred_features_combined)

```


---
## Create Predictions

```{r create_predictions}

# Create Predictions 
pred_tbl <- get_predictions(pred_data_processed_list)

pred_tbl %>% glimpse()

```



---
# Formate Predictions

Additional formatting of predictions data.

```{r format_predictions}

# Format Predictions
pred_final_tbl <- get_predictions_formatted(
    raw_data  = pred_features_combined,
    pred_data = pred_tbl
)

pred_final_tbl %>% glimpse()

```


---

# Upload Predictions to Big Query

Save predictions back to big query

```{r upload_predictions, message=TRUE}

# Upload Predictions
get_bigquery_upload(
    values  = pred_formated_tbl,
    project = "toronto-shelter-project",
    dataset = "data_pred",
    table   = "data_predictions",
    write_disposition = "WRITE_APPEND"
)

```

